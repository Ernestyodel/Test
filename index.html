<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TonFi — Treasury Dashboard</title>
  <meta name="description" content="TonFi treasury portfolio value (USD), live." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#0b1220; --card:#0e1729; --ink:#e8f0ff; --muted:#92a2c6; --brand:#0098ea; --ok:#21d190; --warn:#ffd166;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 800px at 20% -10%, #0f1b33 0%, #0b1220 60%), #0b1220; color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    a{color:var(--brand); text-decoration:none}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:18px clamp(16px, 4vw, 32px); position:sticky; top:0; backdrop-filter:saturate(160%) blur(8px);
      background:linear-gradient(180deg, rgba(12,18,32,.9), rgba(12,18,32,.35) 60%, transparent);
      border-bottom:1px solid rgba(255,255,255,.06); z-index:10;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .brand img{width:36px; height:36px; border-radius:50%; box-shadow:0 6px 16px rgba(0,152,234,.25)}
    .brand h1{font-size:18px; margin:0; font-weight:700; letter-spacing:.2px}
    .tag{padding:6px 10px; border-radius:999px; background:rgba(0,152,234,.12); color:#bfe8ff; font-weight:600; font-size:12px; border:1px solid rgba(0,152,234,.25)}
    main{padding:24px clamp(16px, 4vw, 32px) 56px; max-width:1100px; margin:0 auto}
    .grid{display:grid; grid-template-columns:1fr; gap:18px}
    @media(min-width:760px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.06)}
    .card .hd h2{margin:0; font-size:16px; font-weight:700; letter-spacing:.2px}
    .big{padding:22px 18px 28px}
    .usd{font-size:42px; font-weight:800; letter-spacing:-.5px; line-height:1.1}
    .row{display:flex; flex-wrap:wrap; gap:16px; margin-top:16px}
    .pill{padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06); color:var(--muted); font-weight:600; font-size:12px; border:1px solid rgba(255,255,255,.08)}
    .muted{color:var(--muted)}
    .kvs{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:14px}
    .kv{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px}
    .kv small{display:block; color:var(--muted); font-weight:600}
    .kv strong{font-size:14px}
    .foot{margin-top:24px; font-size:12px; color:var(--muted)}
    .status{display:flex; align-items:center; gap:8px}
    .dot{width:8px; height:8px; border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04); color:var(--ink); font-weight:700}
    .btn:hover{background:rgba(255,255,255,.07)}
    .flex{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .list{padding:14px 18px 18px}
    .list ul{list-style:none; padding:0; margin:0}
    .list li{display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.08)}
    .list li:last-child{border-bottom:none}
    .fade{opacity:.85}
    /* Soft animated accent “TON rain” */
    .rain{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0; opacity:.14}
    .rain i{position:absolute; width:12px; height:14px; background:linear-gradient(180deg,#58caff,#0098ea); clip-path:polygon(50% 0%, 95% 30%, 95% 70%, 50% 100%, 5% 70%, 5% 30%); border-radius:2px; animation:fall linear infinite}
    @keyframes fall{ to{ transform:translateY(120vh) rotate(15deg)} }
  </style>
</head>
<body>
  <div class="rain" aria-hidden="true"></div>

  <header>
    <div class="brand">
      <img src="tonfi-logo.png" alt="TonFi logo" />
      <h1>TonFi</h1>
    </div>
    <span class="tag">Treasury Dashboard</span>
  </header>

  <main>
    <section class="grid">
      <section class="card">
        <div class="hd"><h2>Treasury Total (USD)</h2><div class="status"><span class="dot warn" id="dot"></span><small id="source" class="muted">Loading…</small></div></div>
        <div class="big">
          <div class="usd" id="totalUsd">$0.00</div>
          <div class="row">
            <span class="pill">Address: <a id="addrLink" target="_blank" rel="noopener"></a></span>
            <span class="pill">Last update: <span id="updated">—</span></span>
          </div>

          <div class="kvs">
            <div class="kv"><small>TON balance</small><strong id="tonBal">—</strong></div>
            <div class="kv"><small>TON price (USD)</small><strong id="tonUsd">—</strong></div>
            <div class="kv"><small>Jetton value (USD)</small><strong id="jetUsd">—</strong></div>
            <div class="kv"><small>Valuation coverage</small><strong id="coverage">—</strong></div>
          </div>

          <p class="foot fade">Sums native TON and detected jettons by TonAPI rates; if rates are unavailable, falls back to CoinGecko for TON price (TON-only valuation).</p>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>Breakdown</h2><a class="btn" id="refresh">↻ Refresh</a></div>
        <div class="list">
          <ul id="lines">
            <li><span class="muted">Loading balances…</span><span>—</span></li>
          </ul>
        </div>
      </section>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    const TREASURY = "UQCa8VoKt4HcjEyhmCjY9STErQmRCqPm3n0bJYzG4dQDGLhh";
    const TONSCAN = `https://tonscan.org/address/${TREASURY}`;
    const TONAPI = "https://tonapi.io";
    const COINGECKO_SIMPLE = "https://api.coingecko.com/api/v3/simple/price?ids=toncoin&vs_currencies=usd";

    // ====== UI HOOKS ======
    const addrLink = document.getElementById("addrLink");
    addrLink.textContent = TREASURY.slice(0, 10) + "…" + TREASURY.slice(-6);
    addrLink.href = TONSCAN;

    const totalUsdEl = document.getElementById("totalUsd");
    const tonBalEl = document.getElementById("tonBal");
    const tonUsdEl = document.getElementById("tonUsd");
    const jetUsdEl = document.getElementById("jetUsd");
    const coverageEl = document.getElementById("coverage");
    const updatedEl = document.getElementById("updated");
    const linesEl = document.getElementById("lines");
    const sourceEl = document.getElementById("source");
    const dotEl = document.getElementById("dot");
    const refreshBtn = document.getElementById("refresh");

    // Light animated “TON rain”
    (function spawnRain(){
      const wrap = document.querySelector(".rain");
      const n = 36;
      for(let i=0;i<n;i++){
        const drop = document.createElement("i");
        drop.style.left = Math.random()*100 + "vw";
        drop.style.top = (-10 - Math.random()*120) + "vh";
        drop.style.animationDuration = (6 + Math.random()*8) + "s";
        drop.style.opacity = (0.5 + Math.random()*0.5);
        wrap.appendChild(drop);
      }
    })();

    function fmtUsd(x){ return x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2}); }
    function fmtTon(x){ return x.toLocaleString(undefined,{maximumFractionDigits:4}); }
    function nowLocal(){
      try {
        const dt = new Date();
        return dt.toLocaleString(undefined,{hour12:false});
      } catch { return new Date().toISOString(); }
    }

    async function fetchJson(url){
      const r = await fetch(url, { headers: { "accept":"application/json" }});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function load(){
      refreshBtn.disabled = true;
      sourceEl.textContent = "Fetching TonAPI…";
      dotEl.className = "dot warn";
      linesEl.innerHTML = `<li><span class="muted">Loading balances…</span><span>—</span></li>`;
      tonBalEl.textContent = "—"; tonUsdEl.textContent = "—"; jetUsdEl.textContent = "—";
      coverageEl.textContent = "—"; totalUsdEl.textContent = "$0.00";

      try {
        // 1) Balances (TON + Jettons) via TonAPI
        const acc = await fetchJson(`${TONAPI}/v2/accounts/${TREASURY}`);
        const tonNano = acc.balance ?? acc?.account?.balance ?? 0; // nanotons
        const ton = Number(tonNano) / 1e9;

        // Jettons list with metadata
        const jets = await fetchJson(`${TONAPI}/v2/accounts/${TREASURY}/jettons?limit=200`);
        const jetItems = (jets.balances || jets.items || []).filter(Boolean);

        // Build token list for rate lookup (TON + each jetton master)
        const jetAddrs = [];
        const lines = [];
        for(const it of jetItems){
          const meta = it.jetton || it.jetton_info || {};
          const master = meta?.address || meta?.master || meta?.master_address || meta?.id;
          const symbol = meta?.symbol || meta?.name || "JETTON";
          const decimals = Number(meta?.decimals ?? it?.balance?.decimals ?? 9);
          const raw = Number(it.balance ?? it?.quantity ?? 0);
          const amt = raw / (10 ** decimals);
          if(amt > 0 && master){
            jetAddrs.push(master);
            lines.push({ type:"jetton", master, symbol, amt });
          }
        }

        // 2) Rates via TonAPI (preferred)
        //    Format: /v2/rates?tokens=ton,<jetton-addr1>,<jetton-addr2>&currencies=usd
        let rates;
        try {
          const tokenParam = ["ton", ...jetAddrs].join(",");
          const r = await fetchJson(`${TONAPI}/v2/rates?tokens=${encodeURIComponent(tokenParam)}&currencies=usd`);
          rates = r?.rates || r;
        } catch (e){ /* continue to fallback for TON price only */ }

        // 3) Fallback: CoinGecko TON price if TonAPI rates missing/limited
        let tonUsdPrice = Number(rates?.TON?.prices?.USD ?? rates?.ton?.prices?.usd);
        if(!tonUsdPrice || !isFinite(tonUsdPrice)){
          const cg = await fetchJson(COINGECKO_SIMPLE);
          tonUsdPrice = Number(cg?.toncoin?.usd);
          sourceEl.textContent = "Prices: CoinGecko (fallback) + TonAPI balances";
        } else {
          sourceEl.textContent = "Prices & balances: TonAPI";
        }

        // Compute TON value
        const tonUsd = ton * (tonUsdPrice || 0);

        // Compute Jetton USD using TonAPI rates when available
        let jetUsd = 0;
        const rows = [];
        rows.push(["TON", fmtTon(ton), tonUsdPrice ? fmtUsd(tonUsd) : "—"]);

        for(const row of lines){
          const price = Number(
            rates?.[row.master]?.prices?.USD ??
            rates?.[row.master]?.prices?.usd ??
            rates?.[row.symbol]?.prices?.USD
          );
          const val = (price && isFinite(price)) ? row.amt * price : 0;
          jetUsd += val;
          rows.push([row.symbol, row.amt.toLocaleString(undefined,{maximumFractionDigits:6}), price ? fmtUsd(val) : "—"]);
        }

        // Coverage label
        const covered = rows.filter(r => r[2] !== "—").length - 1; // minus TON if not covered
        const totalTracked = lines.length + 1;
        coverageEl.textContent = `${covered}/${totalTracked} priced`;

        // Totals
        tonBalEl.textContent = fmtTon(ton) + " TON";
        tonUsdEl.textContent = tonUsdPrice ? fmtUsd(tonUsdPrice) : "—";
        jetUsdEl.textContent = fmtUsd(jetUsd);

        const total = tonUsd + jetUsd;
        totalUsdEl.textContent = fmtUsd(total);
        updatedEl.textContent = nowLocal();

        // Render breakdown
        linesEl.innerHTML = "";
        for(const r of rows){
          const li = document.createElement("li");
          li.innerHTML = `<span>${r[0]}</span><span class="muted">${r[1]}</span><strong>${r[2]}</strong>`;
          linesEl.appendChild(li);
        }

        dotEl.className = "dot ok";
      } catch (err){
        sourceEl.textContent = "Failed to load data";
        dotEl.className = "dot warn";
        linesEl.innerHTML = `<li><span class="muted">Error</span><span>${err.message}</span></li>`;
      } finally {
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener("click", load);
    load();
  </script>
</body>
</html>
