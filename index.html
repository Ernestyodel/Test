<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TonFi — Index & Rewards (TON)</title>
<meta name="description" content="TonFi on TON: index-style treasury, live rewards dashboard, and wallet connect."/>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220; --panel:#0e1729; --ink:#eaf2ff; --muted:#96a7c8; --brand:#0098ea; --ok:#21d190; --warn:#ffd166;
  --b:#1b2945; --radius:18px;
}
*{box-sizing:border-box}html,body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, #0f1b33 0%, #0b1220 60%), #0b1220;color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:var(--brand);text-decoration:none}
header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px clamp(14px,4vw,28px);background:rgba(7,12,24,.7);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:34px;height:34px;border-radius:50%;box-shadow:0 6px 16px rgba(0,152,234,.25)}
.brand h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.2px}
.nav{display:flex;gap:10px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:999px;font-weight:700;font-size:13px}
.tab.active{background:rgba(0,152,234,.16);border-color:rgba(0,152,234,.3)}
main{max-width:1120px;margin:0 auto;padding:20px clamp(14px,4vw,28px) 56px}
.grid{display:grid;grid-template-columns:1fr;gap:18px}
@media(min-width:860px){.grid{grid-template-columns:1.2fr .8fr}}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius)}
.card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.card .hd h2{margin:0;font-size:16px;letter-spacing:.2px}
.big{padding:20px}
.usd{font-size:40px;font-weight:800;letter-spacing:-.5px}
.row{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-weight:600;font-size:12px}
.kvs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.kv{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
.kv small{display:block;color:var(--muted);font-weight:600}
.kv strong{font-size:14px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);color:var(--ink);font-weight:700}
.btn:hover{background:rgba(255,255,255,.07)}
.list{padding:12px 16px 16px}
.list ul{list-style:none;margin:0;padding:0}
.list li{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
.list li:last-child{border-bottom:none}
.muted{color:var(--muted)}
.status{display:flex;align-items:center;gap:8px}
.dot{width:8px;height:8px;border-radius:50%}.ok{background:var(--ok)}.warn{background:var(--warn)}
.hero{padding:28px;border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);background:linear-gradient(180deg,rgba(0,152,234,.12),rgba(255,255,255,0))}
.hero h2{margin:0 0 8px;font-size:28px}
.hero p{margin:0;color:#cfe6ff}
footer{margin-top:28px;color:var(--muted);font-size:12px}
.rain{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:0;opacity:.12}
.rain i{position:absolute;width:12px;height:14px;background:linear-gradient(180deg,#58caff,#0098ea);clip-path:polygon(50% 0%, 95% 30%, 95% 70%, 50% 100%, 5% 70%, 5% 30%);border-radius:2px;animation:fall linear infinite}
@keyframes fall{to{transform:translateY(120vh) rotate(15deg)}}
.connect{display:flex;gap:10px;flex-wrap:wrap}
.cta{display:flex;gap:10px;flex-wrap:wrap}
.hide{display:none}
</style>
</head>
<body>
<div class="rain" aria-hidden="true"></div>
<header>
  <div class="brand">
    <img src="tonfi-logo.png" alt="TonFi logo"/>
    <h1>TonFi</h1>
  </div>
  <nav class="nav">
    <a href="#home" class="tab active" data-tab="home">Home</a>
    <a href="#index" class="tab" data-tab="index">Index</a>
    <a href="#rewards" class="tab" data-tab="rewards">Rewards</a>
  </nav>
  <div class="connect">
    <button id="connect" class="tab">Connect Wallet</button>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="home" class="page">
    <div class="hero">
      <h2>Solana-style dashboard, but for <strong>TON</strong>.</h2>
      <p>Index-like TonFi concept with live treasury valuation and a rewards feed — inspired by Burrito.fi’s UX, rebuilt for the TON ecosystem.</p>
      <div class="cta" style="margin-top:14px">
        <a class="btn" href="#index">Learn the Index</a>
        <a class="btn" href="#rewards">View Rewards</a>
      </div>
    </div>

    <section class="grid" style="margin-top:18px">
      <section class="card">
        <div class="hd">
          <h2>Treasury Total (USD)</h2>
          <div class="status"><span id="srcDot" class="dot warn"></span><small id="srcTxt" class="muted">Loading…</small></div>
        </div>
        <div class="big">
          <div id="treasuryUsd" class="usd">$0.00</div>
          <div class="row">
            <span class="pill">Treasury: <a id="addrLink" target="_blank" rel="noopener"></a></span>
            <span class="pill">Updated: <span id="updated">—</span></span>
          </div>
          <div class="kvs">
            <div class="kv"><small>TON balance</small><strong id="tonBal">—</strong></div>
            <div class="kv"><small>TON price (USD)</small><strong id="tonPrice">—</strong></div>
            <div class="kv"><small>Jettons value (USD)</small><strong id="jetUsd">—</strong></div>
            <div class="kv"><small>Coverage</small><strong id="coverage">—</strong></div>
          </div>
          <p class="muted" style="margin-top:12px">Data via TonAPI (balances & rates); if prices rate-limit, falls back to TON USD from a secondary source.</p>
        </div>
      </section>

      <section class="card">
        <div class="hd"><h2>Breakdown</h2><a id="refreshBal" class="btn">↻ Refresh</a></div>
        <div class="list"><ul id="holdings"><li><span class="muted">Loading…</span><span>—</span></li></ul></div>
      </section>
    </section>

    <footer>© TonFi • Built for TON. Wallet connection by TonConnect.</footer>
  </section>

  <!-- INDEX -->
  <section id="index" class="page hide">
    <section class="card">
      <div class="hd"><h2>TonFi Index</h2></div>
      <div class="big">
        <p class="muted">One token. Treasury-driven exposure to TON ecosystem assets. Flow from activity strengthens reserves and supports rewards.</p>
        <div class="kvs">
          <div class="kv"><small>Chain</small><strong>TON</strong></div>
          <div class="kv"><small>Treasury</small><strong id="shortAddr">—</strong></div>
          <div class="kv"><small>Dashboard</small><strong><a href="#rewards">Rewards page</a></strong></div>
          <div class="kv"><small>DEX</small><strong><a id="dexLink" target="_blank" rel="noopener">DeDust / STON.fi</a></strong></div>
        </div>
      </div>
    </section>
  </section>

  <!-- REWARDS -->
  <section id="rewards" class="page hide">
    <section class="card">
      <div class="hd">
        <h2>Protocol Rewards (TON)</h2>
        <a id="refreshRw" class="btn">↻ Refresh</a>
      </div>
      <div class="big">
        <div class="row">
          <span class="pill">Rewards wallet: <a id="rwAddr" target="_blank" rel="noopener">—</a></span>
          <span class="pill">Status: <span id="rwStatus">Setup needed</span></span>
        </div>
        <div class="kvs" style="margin-top:10px">
          <div class="kv"><small>Total TON Distributed</small><strong id="rwTotal">—</strong></div>
          <div class="kv"><small>Payout Cycles</small><strong id="rwCycles">—</strong></div>
          <div class="kv"><small>Unique Recipients</small><strong id="rwRecipients">—</strong></div>
          <div class="kv"><small>Last 24h</small><strong id="rw24h">—</strong></div>
        </div>
        <p class="muted" style="margin-top:12px">Reads outbound native TON from the rewards wallet and summarizes cycles (similar layout to Burrito.fi’s Rewards dashboard). Set the wallet below.</p>
        <div class="row" style="margin-top:10px">
          <input id="rwInput" placeholder="Paste rewards wallet (EQ…/UQ…)" style="flex:1; padding:10px;border-radius:10px;border:1px solid var(--b);background:#0a1220;color:var(--ink)"/>
          <button id="rwSave" class="btn">Save</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd"><h2>Latest Payouts</h2></div>
      <div class="list"><ul id="rwTxs"><li><span class="muted">No rewards wallet set.</span><span>—</span></li></ul></div>
    </section>
  </section>
</main>

<!-- TonConnect UI (wallet connect on TON) -->
<script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
<script>
/** ====== CONFIG ====== **/
const TREASURY = "UQCa8VoKt4HcjEyhmCjY9STErQmRCqPm3n0bJYzG4dQDGLhh";
const TONSCAN = (a)=>`https://tonscan.org/address/${a}`;
const TONAPI = "https://tonapi.io";
const COINGECKO_TON = "https://api.coingecko.com/api/v3/simple/price?ids=toncoin&vs_currencies=usd"; // fallback

// rewards wallet (set later, stored in localStorage)
let REWARDS_WALLET = localStorage.getItem("tonfi_rewards_wallet") || "";

/** ====== NAV & RAIN ====== **/
(function spawnRain(){const wrap=document.querySelector(".rain");const n=36;for(let i=0;i<n;i++){const d=document.createElement("i");d.style.left=Math.random()*100+"vw";d.style.top=(-10-Math.random()*120)+"vh";d.style.animationDuration=(6+Math.random()*8)+"s";d.style.opacity=(0.5+Math.random()*0.5);wrap.appendChild(d);}})();

function show(tab){document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));document.querySelectorAll(".page").forEach(p=>p.classList.add("hide"));document.querySelector(`[data-tab="${tab}"]`)?.classList.add("active");document.getElementById(tab)?.classList.remove("hide");}
window.addEventListener("hashchange",()=>show(location.hash.replace("#","")||"home"));
show(location.hash.replace("#","")||"home");

/** ====== WALLET CONNECT (TonConnect) ====== **/
const connectBtn = document.getElementById("connect");
const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({manifestUrl:"https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json"});
connectBtn.addEventListener("click",()=>tonConnectUI.openModal());

/** ====== TREASURY DASHBOARD ====== **/
const addrLink=document.getElementById("addrLink"); addrLink.textContent=TREASURY.slice(0,10)+"…"+TREASURY.slice(-6); addrLink.href=TONSCAN(TREASURY);
document.getElementById("shortAddr").textContent=TREASURY.slice(0,8)+"…"+TREASURY.slice(-6);
document.getElementById("dexLink").href="https://dedust.io"; // adjust to your live market later

const srcDot=document.getElementById("srcDot"), srcTxt=document.getElementById("srcTxt");
const treasuryUsd=document.getElementById("treasuryUsd"), tonBalEl=document.getElementById("tonBal"), tonPriceEl=document.getElementById("tonPrice"), jetUsdEl=document.getElementById("jetUsd"), covEl=document.getElementById("coverage"), updatedEl=document.getElementById("updated"), holdingsEl=document.getElementById("holdings");

function fmtUsd(x){return x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});}
function fmtTon(x){return x.toLocaleString(undefined,{maximumFractionDigits:4});}
function nowLocal(){try{return new Date().toLocaleString(undefined,{hour12:false});}catch{return new Date().toISOString();}}
async function getJSON(u){const r=await fetch(u,{headers:{accept:"application/json"}});if(!r.ok)throw new Error("HTTP "+r.status);return r.json();}

async function loadTreasury(){
  document.getElementById("refreshBal").disabled=true;
  srcTxt.textContent="TonAPI…"; srcDot.className="dot warn";
  holdingsEl.innerHTML=`<li><span class="muted">Loading…</span><span>—</span></li>`;
  tonBalEl.textContent="—"; tonPriceEl.textContent="—"; jetUsdEl.textContent="—"; covEl.textContent="—"; treasuryUsd.textContent="$0.00";

  try{
    const acc = await getJSON(`${TONAPI}/v2/accounts/${TREASURY}`);
    const tonNano = acc.balance ?? acc?.account?.balance ?? 0;
    const ton = Number(tonNano)/1e9;

    const jets = await getJSON(`${TONAPI}/v2/accounts/${TREASURY}/jettons?limit=200`);
    const jetItems = (jets.balances || jets.items || []).filter(Boolean);

    const tokens = ["ton"]; const list=[];
    for(const it of jetItems){
      const meta=it.jetton||it.jetton_info||{};
      const master=meta?.address||meta?.master||meta?.master_address||meta?.id;
      const sym=meta?.symbol||meta?.name||"JETTON";
      const dec=Number(meta?.decimals ?? it?.balance?.decimals ?? 9);
      const amt=Number(it.balance??it?.quantity??0)/(10**dec);
      if(amt>0 && master){ tokens.push(master); list.push({sym, master, amt}); }
    }

    let rates;
    try{
      const param=encodeURIComponent(tokens.join(","));
      const r=await getJSON(`${TONAPI}/v2/rates?tokens=${param}&currencies=usd`);
      rates=r?.rates||r;
      srcTxt.textContent="Prices & balances: TonAPI";
    }catch{ /* continue */ }

    let tonUsdPrice = Number(rates?.TON?.prices?.USD ?? rates?.ton?.prices?.usd);
    if(!tonUsdPrice || !isFinite(tonUsdPrice)){
      const cg=await getJSON(COINGECKO_TON);
      tonUsdPrice=Number(cg?.toncoin?.usd)||0;
      srcTxt.textContent="CoinGecko TON price (fallback) + TonAPI balances";
    }

    const tonVal = ton * (tonUsdPrice||0);
    let jetVal=0;
    const rows=[["TON", fmtTon(ton), tonUsdPrice?fmtUsd(tonVal):"—"]];

    for(const row of list){
      const p=Number(rates?.[row.master]?.prices?.USD ?? rates?.[row.master]?.prices?.usd);
      const v=(p&&isFinite(p))?row.amt*p:0; jetVal+=v;
      rows.push([row.sym, row.amt.toLocaleString(undefined,{maximumFractionDigits:6}), p?fmtUsd(v):"—"]);
    }

    const covered = rows.filter(r=>r[2]!=="—").length;
    const totalTracked = rows.length;

    tonBalEl.textContent = fmtTon(ton)+" TON";
    tonPriceEl.textContent = tonUsdPrice?fmtUsd(tonUsdPrice):"—";
    jetUsdEl.textContent = fmtUsd(jetVal);
    covEl.textContent = `${covered}/${totalTracked} priced`;

    treasuryUsd.textContent = fmtUsd(tonVal+jetVal);
    updatedEl.textContent = nowLocal();

    holdingsEl.innerHTML="";
    rows.forEach(r=>{
      const li=document.createElement("li");
      li.innerHTML=`<span>${r[0]}</span><span class="muted">${r[1]}</span><strong>${r[2]}</strong>`;
      holdingsEl.appendChild(li);
    });

    srcDot.className="dot ok";
  }catch(e){
    srcTxt.textContent="Failed to load"; srcDot.className="dot warn";
    holdingsEl.innerHTML=`<li><span class="muted">Error</span><span>${e.message}</span></li>`;
  }finally{ document.getElementById("refreshBal").disabled=false; }
}
document.getElementById("refreshBal").addEventListener("click", loadTreasury);
loadTreasury();

/** ====== REWARDS DASHBOARD (similar to Burrito Rewards) ====== **/
const rwAddrLink=document.getElementById("rwAddr"), rwStatus=document.getElementById("rwStatus"), rwTotal=document.getElementById("rwTotal"), rwCycles=document.getElementById("rwCycles"), rwRecipients=document.getElementById("rwRecipients"), rw24h=document.getElementById("rw24h"), rwList=document.getElementById("rwTxs");
const rwInput=document.getElementById("rwInput"), rwSave=document.getElementById("rwSave");
if(REWARDS_WALLET){ rwAddrLink.textContent=REWARDS_WALLET.slice(0,10)+"…"+REWARDS_WALLET.slice(-6); rwAddrLink.href=TONSCAN(REWARDS_WALLET); rwStatus.textContent="Active"; }

rwSave.addEventListener("click", ()=>{
  const v=rwInput.value.trim();
  if(!v){alert("Paste a rewards wallet (EQ… / UQ…)");return;}
  REWARDS_WALLET=v; localStorage.setItem("tonfi_rewards_wallet", v);
  rwAddrLink.textContent=v.slice(0,10)+"…"+v.slice(-6); rwAddrLink.href=TONSCAN(v); rwStatus.textContent="Active";
  loadRewards();
});

async function loadRewards(){
  document.getElementById("refreshRw").disabled=true;
  rwList.innerHTML=`<li><span class="muted">${REWARDS_WALLET? "Loading payouts…" : "No rewards wallet set."}</span><span>—</span></li>`;
  rwTotal.textContent="—"; rwCycles.textContent="—"; rwRecipients.textContent="—"; rw24h.textContent="—";
  if(!REWARDS_WALLET){ document.getElementById("refreshRw").disabled=false; return; }

  try{
    // pull recent transactions (paginate if needed)
    const tx = await getJSON(`${TONAPI}/v2/blockchain/accounts/${REWARDS_WALLET}/transactions?limit=100`);
    const items = tx?.transactions || tx?.items || [];
    // consider outbound native TON only (transfers where this wallet is sender and value>0)
    const outs = items.filter(t => t.in_msg?.source === REWARDS_WALLET && Number(t.in_msg?.value||0)===0 && t.out_msgs?.length)
      .flatMap(t => t.out_msgs.map(o => ({time:(t.utime||t.now||Date.parse(t.created_at)/1000)||0, to:o.destination, amount:Number(o.value||0)/1e9, hash:t.hash||t.transaction_id?.hash||""})))
      .filter(x=>x.amount>0);

    // totals
    const total = outs.reduce((s,x)=>s+x.amount,0);
    rwTotal.textContent = total.toLocaleString(undefined,{maximumFractionDigits:4})+" TON";

    // cycles (roughly group by hour)
    const byCycle = new Map();
    outs.forEach(x=>{
      const hour = Math.floor(x.time/3600);
      byCycle.set(hour, (byCycle.get(hour)||0)+x.amount);
    });
    rwCycles.textContent = byCycle.size.toString();

    // unique recipients
    const uniq = new Set(outs.map(x=>x.to));
    rwRecipients.textContent = uniq.size.toString();

    // last 24h
    const now = Math.floor(Date.now()/1000);
    const last24 = outs.filter(x=> now - x.time <= 86400).reduce((s,x)=>s+x.amount,0);
    rw24h.textContent = last24.toLocaleString(undefined,{maximumFractionDigits:4})+" TON";

    // list latest
    rwList.innerHTML="";
    outs.slice(0,10).forEach(x=>{
      const d=new Date(x.time*1000).toLocaleString(undefined,{hour12:false});
      const li=document.createElement("li");
      const link=`https://tonviewer.com/transaction/${x.hash}`;
      li.innerHTML=`<span class="muted">${d}</span><span>${x.amount.toLocaleString(undefined,{maximumFractionDigits:4})} TON</span><a target="_blank" rel="noopener" href="${link}">View</a>`;
      rwList.appendChild(li);
    });
  }catch(e){
    rwList.innerHTML=`<li><span class="muted">Error</span><span>${e.message}</span></li>`;
  }finally{
    document.getElementById("refreshRw").disabled=false;
  }
}
document.getElementById("refreshRw").addEventListener("click", loadRewards);
if(REWARDS_WALLET) loadRewards();
</script>
</body>
</html>
