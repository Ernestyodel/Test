<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TonFi — Treasury & DAO</title>
  <meta name="description" content="TonFi • Community-driven treasury on TON with a clean DAO suggestion flow and a live treasury value widget." />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config for a clean, modern look
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ton: {
              50: '#ECF9FF',
              100: '#D6F1FF',
              200: '#AEE2FF',
              300: '#7ED0FF',
              400: '#4DB9FF',
              500: '#25A3FF',
              600: '#0D8CEF',
              700: '#0A6FC0',
              800: '#0A5A9A',
              900: '#0C4A7D',
            }
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.08)' }
        }
      }
    }
  </script>
  <link rel="icon" href="tonfi-logo.png" />
  <style>
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <!-- Navbar -->
  <header class="sticky top-0 z-30 bg-slate-950/70 glass border-b border-white/5">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="tonfi-logo.png" alt="TonFi" class="h-9 w-9 rounded-full ring-1 ring-white/10" />
        <span class="font-semibold tracking-tight text-white">TonFi</span>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#treasury" class="hover:text-ton-300 transition">Treasury</a>
        <a href="#dao" class="hover:text-ton-300 transition">DAO</a>
        <a href="#about" class="hover:text-ton-300 transition">About</a>
      </nav>
      <a href="https://t.me/" target="_blank" class="inline-flex items-center gap-2 rounded-2xl bg-ton-500 hover:bg-ton-400 active:bg-ton-600 transition px-4 py-2 text-sm font-semibold shadow-soft">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M9.04 15.314 8.89 19.09c.54 0 .78-.232 1.062-.51l2.55-2.46 5.29 3.876c.97.535 1.66.253 1.93-.9l3.5-16.39.001-.001c.31-1.45-.52-2.02-1.48-1.67L1.6 9.25c-1.42.55-1.4 1.34-.24 1.7l5.72 1.78L19.65 5.2c.63-.413 1.2-.184.73.23"/></svg>
        Join Telegram
      </a>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-ton-900/40 via-slate-900 to-slate-950"></div>
    <div class="relative mx-auto max-w-7xl px-4 py-20 md:py-28">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h1 class="text-4xl md:text-6xl font-extrabold leading-tight tracking-tight">
            Community-Driven <span class="text-ton-400">Treasury</span> on TON
          </h1>
          <p class="mt-4 text-slate-300 max-w-xl">
            TonFi allocates buy-side liquidity into curated TON ecosystem tokens. Holders benefit via buy-back-and-burn and passive distributions.
          </p>
          <div class="mt-8 flex flex-wrap gap-3">
            <a href="#treasury" class="rounded-2xl bg-white text-slate-900 hover:bg-slate-100 transition px-5 py-3 text-sm font-semibold shadow-soft">View Treasury</a>
            <a href="#dao" class="rounded-2xl border border-white/10 hover:border-white/20 px-5 py-3 text-sm font-semibold">Suggest a Token</a>
          </div>
          <p class="mt-3 text-xs text-slate-400">Treasury address: <span id="addrText" class="font-mono"></span></p>
        </div>
        <div class="relative">
          <div class="rounded-3xl border border-white/10 p-6 bg-slate-900/40 shadow-soft">
            <div class="text-xs uppercase tracking-widest text-slate-400 mb-2">Live Treasury Value</div>
            <div class="flex items-end gap-3">
              <div id="treasuryValue" class="text-5xl md:text-6xl font-extrabold">$—</div>
              <div id="treasuryBadge" class="mb-2 text-xs px-2 py-1 rounded-full bg-white/5 border border-white/10 text-slate-300">Loading…</div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
              <div class="rounded-2xl border border-white/10 p-4">
                <div class="text-slate-400">TON Balance</div>
                <div id="tonBalance" class="font-semibold">—</div>
              </div>
              <div class="rounded-2xl border border-white/10 p-4">
                <div class="text-slate-400">Last Updated</div>
                <div id="lastUpdated" class="font-semibold">—</div>
              </div>
            </div>
            <button id="refreshBtn" class="mt-6 w-full rounded-2xl bg-ton-500 hover:bg-ton-400 active:bg-ton-600 transition px-5 py-3 text-sm font-semibold">Refresh</button>
            <p class="mt-3 text-xs text-slate-400" id="dataSource">Data source: —</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Treasury Section -->
  <section id="treasury" class="relative border-t border-white/5">
    <div class="absolute inset-0 pointer-events-none bg-[radial-gradient(ellipse_at_bottom,_var(--tw-gradient-stops))] from-ton-900/20 via-slate-950 to-slate-950"></div>
    <div class="relative mx-auto max-w-7xl px-4 py-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl md:text-3xl font-bold">Treasury Overview</h2>
        <a id="viewOnExplorer" target="_blank" class="text-sm text-ton-300 hover:text-ton-200 underline underline-offset-4">Open in Explorer</a>
      </div>
      <p class="text-slate-300 max-w-3xl">Below is an aggregated USD value of the treasury wallet. If the primary data provider is rate-limited, this widget automatically falls back to alternative sources and clearly labels the mode.</p>
    </div>
  </section>

  <!-- DAO: Suggest a Token -->
  <section id="dao" class="relative border-t border-white/5">
    <div class="relative mx-auto max-w-7xl px-4 py-16">
      <div class="grid md:grid-cols-2 gap-10 items-start">
        <div>
          <h2 class="text-2xl md:text-3xl font-bold">DAO: Suggest a Token</h2>
          <p class="mt-2 text-slate-300">Have a token TonFi should buy and hold? Share your best ideas with a short rationale. Popular suggestions will be reviewed and queued for on-chain votes.</p>
          <ul class="mt-4 space-y-2 text-sm text-slate-300">
            <li>• Transparent queue of community suggestions</li>
            <li>• Periodic shortlists for holder voting</li>
            <li>• Buy-back-and-burn funded by treasury yields</li>
          </ul>

          <!-- Live list -->
          <div class="mt-8">
            <h3 class="font-semibold mb-2">Recent Suggestions</h3>
            <div id="suggestionsList" class="space-y-3 text-sm">
              <div class="text-slate-400">Loading…</div>
            </div>
          </div>
        </div>

        <div class="rounded-3xl border border-white/10 p-6 bg-slate-900/40 shadow-soft">
          <form id="suggestForm" class="space-y-4" data-enhanced>
            <input type="hidden" name="ua" value="" />
            <input type="hidden" name="ref" value="" />
            <div>
              <label class="block text-sm text-slate-300 mb-1">Token (name or jetton address)</label>
              <input required name="token" class="w-full rounded-2xl bg-slate-950 border border-white/10 px-4 py-3 outline-none focus:border-ton-400" placeholder="e.g., NOT, STON, or EQC…" />
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-1">Why should TonFi buy this?</label>
              <textarea required name="reason" rows="3" class="w-full rounded-2xl bg-slate-950 border border-white/10 px-4 py-3 outline-none focus:border-ton-400" placeholder="Brief, specific reasons: liquidity, volume, catalysts, fundamentals…"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <input name="handle" class="rounded-2xl bg-slate-950 border border-white/10 px-4 py-3 outline-none focus:border-ton-400" placeholder="@telegram (optional)" />
              <input name="email" type="email" class="rounded-2xl bg-slate-950 border border-white/10 px-4 py-3 outline-none focus:border-ton-400" placeholder="Email (optional)" />
            </div>

            <button class="w-full rounded-2xl bg-white text-slate-900 hover:bg-slate-100 active:bg-white transition px-5 py-3 text-sm font-semibold">Submit Suggestion</button>
            <p class="text-xs text-slate-400">Submissions are stored server-side and shown in the list. If the API is unavailable, the site falls back to email so nothing gets lost.</p>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- About -->
  <section id="about" class="relative border-t border-white/5">
    <div class="relative mx-auto max-w-7xl px-4 py-16">
      <div class="grid md:grid-cols-3 gap-8">
        <div class="rounded-3xl border border-white/10 p-6 bg-slate-900/40">
          <h3 class="font-semibold mb-2">Tax Structure</h3>
          <p class="text-slate-300 text-sm">Target 5/5 or 5/7: buy/sell fees route 3–5% to liquidity + buy-back-and-burn; 2% distributed to holders as passive income.</p>
        </div>
        <div class="rounded-3xl border border-white/10 p-6 bg-slate-900/40">
          <h3 class="font-semibold mb-2">Treasury Strategy</h3>
          <p class="text-slate-300 text-sm">Use LP fees and curated holdings to accumulate yield, powering buybacks and long-term scarcity.</p>
        </div>
        <div class="rounded-3xl border border-white/10 p-6 bg-slate-900/40">
          <h3 class="font-semibold mb-2">Transparency</h3>
          <p class="text-slate-300 text-sm">Live wallet value, clear rebalancing notes, and public vote records for allocations.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-white/5">
    <div class="mx-auto max-w-7xl px-4 py-10 text-sm text-slate-400 flex flex-col md:flex-row items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="tonfi-logo.png" alt="TonFi" class="h-7 w-7 rounded-full ring-1 ring-white/10" />
        <span>© <span id="year"></span> TonFi • Built on TON</span>
      </div>
      <div class="flex items-center gap-4">
        <a href="#dao" class="hover:text-slate-200">Submit a Token</a>
        <a href="#treasury" class="hover:text-slate-200">Treasury</a>
      </div>
    </div>
  </footer>

  <!-- ====== CONFIG ====== -->
  <script>
    // >>>> Your treasury address
    const TREASURY_ADDRESS = 'UQCa8VoKt4HcjEyhmCjY9STErQmRCqPm3n0bJYzG4dQDGLhh';

    // API-first (serverless) submission
    const SUGGEST_POST_URL = '/api/suggest';
  </script>

  <!-- ====== APP LOGIC ====== -->
  <script>
    const $ = (id) => document.getElementById(id);
    const fmtUSD = (n) => n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
    const fmtTON = (n) => `${n.toLocaleString(undefined, { maximumFractionDigits: 4 })} TON`;
    const cacheKey = (k) => `tonfi_${k}`;

    function setUI({ usd, ton, source, badge, when }) {
      if (usd != null) $('treasuryValue').textContent = fmtUSD(usd);
      if (ton != null) $('tonBalance').textContent = fmtTON(ton);
      if (source) $('dataSource').textContent = `Data source: ${source}`;
      if (badge) $('treasuryBadge').textContent = badge;
      $('lastUpdated').textContent = when ? new Date(when).toLocaleString() : new Date().toLocaleString();
    }

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
      return res.json();
    }

    // Primary: TonAPI Portfolio (includes jettons, gives total USD)
    async function tryTonapiPortfolio(address) {
      const url = `https://tonapi.io/v2/accounts/${address}/portfolio`;
      const data = await fetchJSON(url);
      const usd = data?.total_usd_amount ?? data?.total_amount_usd ?? null;
      let ton = null;
      try {
        const acc = await fetchJSON(`https://tonapi.io/v2/accounts/${address}`);
        if (acc?.balance != null) ton = acc.balance / 1e9;
      } catch (_) {}
      return { usd, ton, source: 'TonAPI /portfolio', badge: 'Full portfolio', when: Date.now() };
    }

    // Fallback A: TON-only (TonAPI account + Coingecko for price)
    async function tryTonOnlyTonapi(address) {
      const acc = await fetchJSON(`https://tonapi.io/v2/accounts/${address}`);
      const ton = (acc?.balance ?? 0) / 1e9;
      const cg = await fetchJSON('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd');
      const tonUsd = cg?.['the-open-network']?.usd ?? 0;
      const usd = ton * tonUsd;
      return { usd, ton, source: 'TonAPI + Coingecko', badge: 'TON-only fallback', when: Date.now() };
    }

    // Fallback B: Toncenter + Coingecko
    async function tryTonOnlyToncenter(address) {
      const url = `https://toncenter.com/api/v2/getAddressInformation?address=${encodeURIComponent(address)}`;
      const data = await fetchJSON(url);
      const ton = (data?.result?.balance ?? 0) / 1e9;
      const cg = await fetchJSON('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd');
      const tonUsd = cg?.['the-open-network']?.usd ?? 0;
      const usd = ton * tonUsd;
      return { usd, ton, source: 'Toncenter + Coingecko', badge: 'TON-only fallback', when: Date.now() };
    }

    async function loadTreasury(address) {
      // 60s cache
      const cached = localStorage.getItem(cacheKey('treasury'));
      if (cached) {
        try {
          const obj = JSON.parse(cached);
          if (Date.now() - obj.when < 60_000) setUI(obj);
        } catch(_) {}
      }
      // Try providers in order
      const attempts = [tryTonapiPortfolio, tryTonOnlyTonapi, tryTonOnlyToncenter];
      for (const fn of attempts) {
        try {
          const result = await fn(address);
          setUI(result);
          localStorage.setItem(cacheKey('treasury'), JSON.stringify(result));
          return;
        } catch (e) { console.warn('Provider failed:', fn.name, e); }
      }
      setUI({ usd: 0, ton: null, source: '—', badge: 'Unavailable', when: Date.now() });
    }

    async function loadSuggestions() {
      const el = document.getElementById('suggestionsList');
      if (!el) return;
      try {
        const res = await fetch('/api/suggestions');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const items = await res.json();
        if (!Array.isArray(items) || items.length === 0) {
          el.innerHTML = '<div class="text-slate-400">No suggestions yet. Be the first!</div>';
          return;
        }
        el.innerHTML = '';
        items.forEach((s) => {
          const card = document.createElement('div');
          card.className = 'rounded-2xl border border-white/10 p-4 bg-slate-950/40';
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-semibold">${(s.token || '').toString().slice(0,80)}</div>
              <div class="text-xs text-slate-400">${new Date(s.ts || Date.now()).toLocaleString()}</div>
            </div>
            <div class="mt-2 text-slate-300">${(s.reason || '').toString().slice(0,300)}</div>
            <div class="mt-2 text-xs text-slate-500">${s.handle ? s.handle : ''} ${s.email ? '• ' + s.email : ''}</div>
          `;
          el.appendChild(card);
        });
      } catch (e) {
        el.innerHTML = '<div class="text-amber-300">API unavailable. Suggestions will still be emailed on submit.</div>';
      }
    }

    function setupDAOForm() {
      const form = document.getElementById('suggestForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = Object.fromEntries(fd.entries());

        // API first
        try {
          const resp = await fetch(SUGGEST_POST_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error('Bad response');
          alert('Thanks! Your suggestion was recorded.');
          form.reset();
          loadSuggestions();
          return;
        } catch (_) {}

        // Fallback: mailto (never lose a suggestion)
        const subject = encodeURIComponent('TonFi Token Suggestion');
        const body = encodeURIComponent(`Token: ${payload.token}
Reason: ${payload.reason}
Telegram: ${payload.handle || '-'}
Email: ${payload.email || '-'}`);
        const mailto = `mailto:tonfi.dao+suggestions@example.com?subject=${subject}&body=${body}`;
        try { window.location.href = mailto; } catch(_) {}
        alert('API unavailable — opened your email app as a fallback.');
      });
    }

    // Init
    (function init() {
      $('addrText').textContent = TREASURY_ADDRESS;
      $('viewOnExplorer').href = `https://tonviewer.com/${encodeURIComponent(TREASURY_ADDRESS)}`;
      $('year').textContent = new Date().getFullYear();
      $('refreshBtn').addEventListener('click', () => loadTreasury(TREASURY_ADDRESS));
      setupDAOForm();
      // metadata
      const f = document.getElementById('suggestForm');
      f.querySelector('input[name="ua"]').value = navigator.userAgent;
      f.querySelector('input[name="ref"]').value = document.referrer || location.href;
      loadTreasury(TREASURY_ADDRESS);
      loadSuggestions();
    })();
  </script>

  <!-- ====== SERVERLESS API FILES (create these on Vercel) ======
    Create a folder: /api
    Add two files: /api/suggest.js and /api/suggestions.js

    // /api/suggest.js
    import { kv } from '@vercel/kv';
    export default async function handler(req, res) {
      if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
      try {
        const { token, reason, handle, email, ua, ref } = req.body || {};
        if (!token || !reason) return res.status(400).json({ error: 'token and reason required' });
        const item = { token, reason, handle, email, ua, ref, ts: Date.now() };
        await kv.lpush('tonfi:suggestions', JSON.stringify(item));
        await kv.ltrim('tonfi:suggestions', 0, 199); // keep latest 200
        return res.status(200).json({ ok: true });
      } catch (e) {
        return res.status(500).json({ error: 'failed to save' });
      }
    }

    // /api/suggestions.js
    import { kv } from '@vercel/kv';
    export default async function handler(_req, res) {
      try {
        const raw = await kv.lrange('tonfi:suggestions', 0, 49);
        const items = raw.map((s) => { try { return JSON.parse(s); } catch { return null; } }).filter(Boolean);
        return res.status(200).json(items);
      } catch (e) {
        return res.status(200).json([]);
      }
    }

    === Setup Vercel KV ===
    - In Vercel project ➝ Storage ➝ Add Vercel KV (free tier OK)
    - Vercel will add env vars (KV_REST_API_URL, KV_REST_API_TOKEN, etc.)
    - Add dep: `npm i @vercel/kv`
    - Deploy; the site will use /api endpoints automatically.
  ============================================================= -->
</body>
</html>
